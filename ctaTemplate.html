<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <title></title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
        <link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'HelveticaNeue-Light', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        
        <script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
    </head>
    <body>
        <p>ctaTemplate类所在路径vnpy/trader/app/ctaStrategy/ctaTemplate.py</p>
<pre><code class="language-python"><div><span class="hljs-string">'''
本文件包含了CTA引擎中的策略开发用模板，开发策略时需要继承CtaTemplate类。
'''</span>

<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span>  pd
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime,timedelta,time
<span class="hljs-keyword">import</span> talib
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict
<span class="hljs-keyword">from</span> vnpy.trader.vtConstant <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> vnpy.trader.vtObject <span class="hljs-keyword">import</span> VtBarData
<span class="hljs-keyword">from</span> vnpy.trader.vtUtility <span class="hljs-keyword">import</span> BarGenerator, ArrayManager
<span class="hljs-keyword">from</span> vnpy.trader.utils.email <span class="hljs-keyword">import</span> mail

<span class="hljs-keyword">from</span> .ctaBase <span class="hljs-keyword">import</span> *

<span class="hljs-comment">########################################################################</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CtaTemplate</span><span class="hljs-params">(object)</span>:</span>
    <span class="hljs-string">"""CTA策略模板"""</span>

    <span class="hljs-comment"># 策略类的名称和作者</span>
    className = <span class="hljs-string">'CtaTemplate'</span>
    author = EMPTY_UNICODE

    <span class="hljs-comment"># MongoDB数据库的名称，K线数据库默认为1分钟</span>
    tickDbName = TICK_DB_NAME
    barDbName = MINUTE_DB_NAME

    <span class="hljs-comment"># 策略的基本参数</span>
    name = EMPTY_UNICODE  <span class="hljs-comment"># 策略实例名称</span>
    vtSymbol = EMPTY_STRING        <span class="hljs-comment"># 交易的合约vt系统代码</span>
    productClass = EMPTY_STRING  <span class="hljs-comment"># 产品类型（只有IB接口需要）</span>
    currency = EMPTY_STRING  <span class="hljs-comment"># 货币（只有IB接口需要）</span>

    <span class="hljs-comment"># 策略的基本变量，由引擎管理</span>
    inited = <span class="hljs-keyword">False</span>  <span class="hljs-comment"># 是否进行了初始化</span>
    trading = <span class="hljs-keyword">False</span>  <span class="hljs-comment"># 是否启动交易，由引擎管理</span>
    symbolList = []  <span class="hljs-comment"># 策略的标的列表</span>

    <span class="hljs-comment"># 参数列表，保存了参数的名称,列表里的内容最后会显示在qt界面上</span>
    paramList = [<span class="hljs-string">'name'</span>,
                 <span class="hljs-string">'className'</span>,
                 <span class="hljs-string">'author'</span>,
                 <span class="hljs-string">'symbolList'</span>]

    <span class="hljs-comment"># 变量列表，保存了变量的名称，列表里的内容最后会显示在qt界面上</span>
    varList = [<span class="hljs-string">'inited'</span>,
               <span class="hljs-string">'trading'</span>,
               <span class="hljs-string">'posDict'</span>]

    <span class="hljs-comment"># 同步列表，保存了需要保存到数据库的变量名称</span>
    syncList = [<span class="hljs-string">'posDict'</span>,
                <span class="hljs-string">'eveningDict'</span>,
                <span class="hljs-string">'accountDict'</span>]

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, ctaEngine, setting)</span>:</span>
        <span class="hljs-string">"""Constructor"""</span>
        self.ctaEngine = ctaEngine <span class="hljs-comment">#</span>
        self.posDict = {}<span class="hljs-comment">#仓位字典，形式如同{"eosusd_long":1,"eosusd_short":1}表明多空都有，自动在引擎内部生成</span>
        self.eveningDict = {}<span class="hljs-comment">#保证金字典，一般不用</span>
        self.accountDict = {}<span class="hljs-comment">#账户字典，暂时没用上还不知道干啥的</span>
        <span class="hljs-comment"># 设置策略的参数</span>
        <span class="hljs-keyword">if</span> setting:
            d = self.__dict__
            <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> self.paramList:
                <span class="hljs-keyword">if</span> key <span class="hljs-keyword">in</span> setting:
                    d[key] = setting[key]
        通过setting里的key和value自动在类内部创建属性，通过往self.__dict__[key]=value的方式，不懂的话可以自行百度self.__dict__
        <span class="hljs-comment"># self.posDict = {}</span>
        <span class="hljs-comment"># self.eveningDict = {}</span>
        
    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    NotImplementedError可以实现c++的pure virtual的功能，就是说子类必须继承父类的方法并加以实现，否则就报错
    引擎上会有四个功能键
    初始化-&gt;onInit
    启动-&gt;onStart
    停止-&gt;onStop
    恢复-&gt;onRestore
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInit</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""初始化策略（必须由用户继承实现）"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onStart</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""启动策略（必须由用户继承实现）"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onStop</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""停止策略（必须由用户继承实现）"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onRestore</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""恢复策略（必须由用户继承实现）"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError
    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    程序通过websocket与交易所建立持久化连接，交易所会推送给tick数据，引擎内部会把tick数据处理成固定的数
    据格式,tick的数据格式如下
    <span class="hljs-comment"># class VtTickData(VtBaseData):</span>
    <span class="hljs-comment"># """Tick行情数据类"""</span>

    <span class="hljs-comment"># #----------------------------------------------------------------------</span>
    <span class="hljs-comment"># def __init__(self):</span>
    <span class="hljs-comment">#     """Constructor"""</span>
    <span class="hljs-comment">#     super(VtTickData, self).__init__()</span>
        
    <span class="hljs-comment">#     # 代码相关</span>
    <span class="hljs-comment">#     self.symbol = EMPTY_STRING              # 合约代码</span>
    <span class="hljs-comment">#     self.exchange = EMPTY_STRING            # 交易所代码</span>
    <span class="hljs-comment">#     self.vtSymbol = EMPTY_STRING            # 合约在vt系统中的唯一代码，通常是 合约代码.交易所代码</span>
        
    <span class="hljs-comment">#     # 成交数据</span>
    <span class="hljs-comment">#     self.lastPrice = EMPTY_FLOAT            # 最新成交价</span>
    <span class="hljs-comment">#     self.lastVolume = EMPTY_INT             # 最新成交量</span>
    <span class="hljs-comment">#     self.volume = EMPTY_INT                 # 今天总成交量</span>
    <span class="hljs-comment">#     self.openInterest = EMPTY_INT           # 持仓量</span>
    <span class="hljs-comment">#     self.time = EMPTY_STRING                # 时间 11:20:56.5</span>
    <span class="hljs-comment">#     self.date = EMPTY_STRING                # 日期 20151009</span>
    <span class="hljs-comment">#     self.datetime = None                    # python的datetime时间对象</span>
        
    <span class="hljs-comment">#     # 常规行情</span>
    <span class="hljs-comment">#     self.openPrice = EMPTY_FLOAT            # 今日开盘价</span>
    <span class="hljs-comment">#     self.highPrice = EMPTY_FLOAT            # 今日最高价</span>
    <span class="hljs-comment">#     self.lowPrice = EMPTY_FLOAT             # 今日最低价</span>
    <span class="hljs-comment">#     self.preClosePrice = EMPTY_FLOAT</span>
        
    <span class="hljs-comment">#     self.upperLimit = EMPTY_FLOAT           # 涨停价</span>
    <span class="hljs-comment">#     self.lowerLimit = EMPTY_FLOAT           # 跌停价</span>
        
    <span class="hljs-comment">#     # 五档行情</span>
    <span class="hljs-comment">#     self.bidPrice1 = EMPTY_FLOAT</span>
    <span class="hljs-comment">#     self.bidPrice2 = EMPTY_FLOAT</span>
    <span class="hljs-comment">#     self.bidPrice3 = EMPTY_FLOAT</span>
    <span class="hljs-comment">#     self.bidPrice4 = EMPTY_FLOAT</span>
    <span class="hljs-comment">#     self.bidPrice5 = EMPTY_FLOAT</span>
    <span class="hljs-comment">#     self.askPrice1 = EMPTY_FLOAT</span>
    <span class="hljs-comment">#     self.askPrice2 = EMPTY_FLOAT</span>
    <span class="hljs-comment">#     self.askPrice3 = EMPTY_FLOAT</span>
    <span class="hljs-comment">#     self.askPrice4 = EMPTY_FLOAT</span>
    <span class="hljs-comment">#     self.askPrice5 = EMPTY_FLOAT        </span>
    <span class="hljs-comment">#     self.bidVolume1 = EMPTY_INT</span>
    <span class="hljs-comment">#     self.bidVolume2 = EMPTY_INT</span>
    <span class="hljs-comment">#     self.bidVolume3 = EMPTY_INT</span>
    <span class="hljs-comment">#     self.bidVolume4 = EMPTY_INT</span>
    <span class="hljs-comment">#     self.bidVolume5 = EMPTY_INT</span>
    <span class="hljs-comment">#     self.askVolume1 = EMPTY_INT</span>
    <span class="hljs-comment">#     self.askVolume2 = EMPTY_INT</span>
    <span class="hljs-comment">#     self.askVolume3 = EMPTY_INT</span>
    <span class="hljs-comment">#     self.askVolume4 = EMPTY_INT</span>
    <span class="hljs-comment">#     self.askVolume5 = EMPTY_INT</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTick</span><span class="hljs-params">(self, tick)</span>:</span>
        <span class="hljs-string">"""收到行情TICK推送（必须由用户继承实现）"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    onOrder会在订单发生变化的时候，进行推送，通过websocket传来，websocket会订阅很多频道，订单这个单独有
    一个频道，行情数据也有单独的频道，传来的是json格式，内部处理成order的数据格式，格式如下
    <span class="hljs-comment"># class VtOrderData(VtBaseData):</span>
    <span class="hljs-comment"># """订单数据类"""</span>

    <span class="hljs-comment"># #----------------------------------------------------------------------</span>
    <span class="hljs-comment"># def __init__(self):</span>
    <span class="hljs-comment">#     """Constructor"""</span>
    <span class="hljs-comment">#     super(VtOrderData, self).__init__()</span>
        
    <span class="hljs-comment">#     # 代码编号相关</span>
    <span class="hljs-comment">#     self.symbol = EMPTY_STRING              # 合约代码</span>
    <span class="hljs-comment">#     self.exchange = EMPTY_STRING            # 交易所代码</span>
    <span class="hljs-comment">#     self.vtSymbol = EMPTY_STRING  # 索引，统一格式：f"{symbol}.{exchange}"</span>
        
    <span class="hljs-comment">#     self.orderID = EMPTY_STRING             # 订单编号 gateway内部自己生成的编号</span>
    <span class="hljs-comment">#     self.vtOrderID = EMPTY_STRING  # 索引，统一格式：f"{gatewayName}.{orderId}"</span>
        
    <span class="hljs-comment">#     # 报单相关</span>
    <span class="hljs-comment">#     self.direction = EMPTY_UNICODE          # 报单方向</span>
    <span class="hljs-comment">#     self.offset = EMPTY_UNICODE             # 报单开平仓</span>
    <span class="hljs-comment">#     self.price = EMPTY_FLOAT                # 报单价格</span>
    <span class="hljs-comment">#     self.totalVolume = EMPTY_INT            # 报单总数量</span>
    <span class="hljs-comment">#     self.tradedVolume = EMPTY_INT           # 报单成交数量</span>
    <span class="hljs-comment">#     self.status = EMPTY_UNICODE             # 报单状态</span>
        
    <span class="hljs-comment">#     self.orderTime = EMPTY_STRING           # 发单时间</span>
    <span class="hljs-comment">#     self.cancelTime = EMPTY_STRING          # 撤单时间</span>
        
    <span class="hljs-comment">#     # CTP/LTS相关</span>
    <span class="hljs-comment">#     self.frontID = EMPTY_INT                # 前置机编号</span>
    <span class="hljs-comment">#     self.sessionID = EMPTY_INT </span>
    交易所会发来一个orderID作为唯一标志，传递某一个订单的状态order.status，有“未成交”，“部分成交”，“全
    部成交”，“已撤销”，“未知”（未知时引擎内部处理的，用于应付掉线情况），vtOrderID是引擎内部根据orderID
    维护的一个列表，也是唯一的，按从<span class="hljs-number">1</span>开始的顺序递增，方便处理，所以一般在策略里都使用order.vtOrderID
    order.vtSymbol是你交易的品种
    order.direction是你下的这单的方向,多或空
    order.offset是你下的这单是开仓还是平仓
    buy-&gt;“多” “开仓”
    sell-&gt;“空” “平仓”
    short-&gt;“空” “开仓”
    cover-&gt;“多” “平仓”
    order.price报单价格
    order.totalVolume报单总数量
    order.tradedVolume成交数量
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onOrder</span><span class="hljs-params">(self, order)</span>:</span>
        <span class="hljs-string">"""收到委托变化推送（必须由用户继承实现）"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    如果是完全成交或部分成交的order.status会被推到onTrade里，顺序在onOrder之后，所以如果要在onTrade里
    写东西，最好不要写交易逻辑，不然会要先运行完onOrder再过来，速度跟不上，或者onOrder自己实现异步的，不
    阻塞到onTrade。
    trade的数据格式如下
    <span class="hljs-comment"># class VtTradeData(VtBaseData):</span>
    <span class="hljs-comment"># """</span>
    <span class="hljs-comment"># 成交数据类</span>
    <span class="hljs-comment"># 一般来说，一个VtOrderData可能对应多个VtTradeData：一个订单可能多次部分成交</span>
    <span class="hljs-comment"># """</span>

    <span class="hljs-comment"># #----------------------------------------------------------------------</span>
    <span class="hljs-comment"># def __init__(self):</span>
    <span class="hljs-comment">#     """Constructor"""</span>
    <span class="hljs-comment">#     super(VtTradeData, self).__init__()</span>
        
    <span class="hljs-comment">#     # 代码编号相关</span>
    <span class="hljs-comment">#     self.symbol = EMPTY_STRING              # 合约代码</span>
    <span class="hljs-comment">#     self.exchange = EMPTY_STRING            # 交易所代码</span>
    <span class="hljs-comment">#     self.vtSymbol = EMPTY_STRING            # 合约在vt系统中的唯一代码，通常是 合约代码.交易所代码</span>

    <span class="hljs-comment">#     self.tradeID = EMPTY_STRING  # 成交编号 gateway内部自己生成的编号</span>
    <span class="hljs-comment">#     self.vtTradeID = EMPTY_STRING           # 成交在vt系统中的唯一编号，通常是 Gateway名.成交编号</span>
        
    <span class="hljs-comment">#     self.orderID = EMPTY_STRING             # 订单编号</span>
    <span class="hljs-comment">#     self.vtOrderID = EMPTY_STRING           # 订单在vt系统中的唯一编号，通常是 Gateway名.订单编号</span>
        
    <span class="hljs-comment">#     # 成交相关</span>
    <span class="hljs-comment">#     self.direction = EMPTY_UNICODE          # 成交方向</span>
    <span class="hljs-comment">#     self.offset = EMPTY_UNICODE             # 成交开平仓</span>
    <span class="hljs-comment">#     self.price = EMPTY_FLOAT                # 成交价格</span>
    <span class="hljs-comment">#     self.volume = EMPTY_INT                 # 成交数量</span>
    <span class="hljs-comment">#     self.tradeTime = EMPTY_STRING           # 成交时间</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTrade</span><span class="hljs-params">(self, trade)</span>:</span>
        <span class="hljs-string">"""收到成交推送（必须由用户继承实现）"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError

    <span class="hljs-comment">#-----------------------------------------------------</span>
    bar就是传统的k线，数据格式如下
    <span class="hljs-comment"># class VtBarData(VtBaseData):</span>
    <span class="hljs-comment"># """K线数据"""</span>

    <span class="hljs-comment"># #----------------------------------------------------------------------</span>
    <span class="hljs-comment"># def __init__(self):</span>
    <span class="hljs-comment">#     """Constructor"""</span>
    <span class="hljs-comment">#     super(VtBarData, self).__init__()</span>
        
    <span class="hljs-comment">#     self.vtSymbol = EMPTY_STRING        # vt系统代码</span>
    <span class="hljs-comment">#     self.symbol = EMPTY_STRING          # 代码</span>
    <span class="hljs-comment">#     self.exchange = EMPTY_STRING        # 交易所</span>
    
    <span class="hljs-comment">#     self.open = EMPTY_FLOAT             # OHLC</span>
    <span class="hljs-comment">#     self.high = EMPTY_FLOAT</span>
    <span class="hljs-comment">#     self.low = EMPTY_FLOAT</span>
    <span class="hljs-comment">#     self.close = EMPTY_FLOAT</span>
        
    <span class="hljs-comment">#     self.date = EMPTY_STRING            # bar开始的时间，日期</span>
    <span class="hljs-comment">#     self.time = EMPTY_STRING            # 时间</span>
    <span class="hljs-comment">#     self.datetime = None                # python的datetime时间对象</span>
        
    <span class="hljs-comment">#     self.volume = EMPTY_INT             # 成交量</span>
    <span class="hljs-comment">#     self.openInterest = EMPTY_INT       # 持仓量  </span>
    <span class="hljs-comment">#     self.interval = EMPTY_UNICODE       # K线周期</span>
    onBar默认是一分钟推送一次，第一次推送在第一个整分钟。
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBar</span><span class="hljs-params">(self, bar)</span>:</span>
        <span class="hljs-string">"""收到Bar推送（必须由用户继承实现）"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    停止单，目前还没用过，等用过再来补充
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onStopOrder</span><span class="hljs-params">(self, so)</span>:</span>
        <span class="hljs-string">"""收到停止单推送（必须由用户继承实现）"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    buy，sell，short，cover是四种下单方式，在onOrder里介绍了

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">buy</span><span class="hljs-params">(self, vtSymbol, price, volume, priceType = PRICETYPE_LIMITPRICE, stop=False)</span>:</span>
        <span class="hljs-string">"""买开"""</span>
        <span class="hljs-keyword">return</span> self.sendOrder(CTAORDER_BUY, vtSymbol, price, volume, priceType, stop)

        <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sell</span><span class="hljs-params">(self, vtSymbol, price, volume, priceType = PRICETYPE_LIMITPRICE, stop=False)</span>:</span>
        <span class="hljs-string">"""卖平"""</span>
        <span class="hljs-keyword">return</span> self.sendOrder(CTAORDER_SELL, vtSymbol, price, volume, priceType, stop)

        <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">short</span><span class="hljs-params">(self, vtSymbol, price, volume, priceType = PRICETYPE_LIMITPRICE, stop=False)</span>:</span>
        <span class="hljs-string">"""卖开"""</span>
        <span class="hljs-keyword">return</span> self.sendOrder(CTAORDER_SHORT, vtSymbol, price, volume, priceType, stop)

        <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cover</span><span class="hljs-params">(self, vtSymbol, price, volume, priceType = PRICETYPE_LIMITPRICE, stop=False)</span>:</span>
        <span class="hljs-string">"""买平"""</span>
        <span class="hljs-keyword">return</span> self.sendOrder(CTAORDER_COVER, vtSymbol, price, volume, priceType, stop)

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    buy，sell，short，cover调用此函数发单
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sendOrder</span><span class="hljs-params">(self, orderType, vtSymbol, price, volume, priceType = PRICETYPE_LIMITPRICE, stop=False)</span>:</span>
        <span class="hljs-string">"""发送委托"""</span>
        <span class="hljs-keyword">if</span> self.trading:
            <span class="hljs-comment"># 如果stop为True，则意味着发本地停止单</span>
            <span class="hljs-keyword">if</span> stop:
                vtOrderIDList = self.ctaEngine.sendStopOrder(vtSymbol, orderType, price, volume, priceType, self)
            <span class="hljs-keyword">else</span>:
                vtOrderIDList = self.ctaEngine.sendOrder(vtSymbol, orderType, price, volume, priceType, self)
            <span class="hljs-keyword">return</span> vtOrderIDList
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 交易停止时发单返回空字符串</span>
            <span class="hljs-keyword">return</span> []

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    cancelOrder取消订单，传入参数是vtOrderID，每次发单buy，sell，cover，short返回值都是一个列表，列表
    里只有一个元素就是vtOrderID，把那个vtOrderID传入可以实现撤单
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cancelOrder</span><span class="hljs-params">(self, vtOrderID)</span>:</span>
        <span class="hljs-string">"""撤单"""</span>
        <span class="hljs-comment"># 如果发单号为空字符串，则不进行后续操作</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> vtOrderID:
            <span class="hljs-keyword">return</span>

        <span class="hljs-keyword">if</span> STOPORDERPREFIX <span class="hljs-keyword">in</span> vtOrderID:
            self.ctaEngine.cancelStopOrder(vtOrderID)
        <span class="hljs-keyword">else</span>:
            self.ctaEngine.cancelOrder(vtOrderID)

        <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    cancelAll是循环vtOrderID去发撤单，所以为了程序的精细化处理一般不用cancelAll
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cancelAll</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""全部撤单"""</span>
        self.ctaEngine.cancelAll(self.name)
        <span class="hljs-comment">#---------</span>
    如上，暂没有使用过StopOrder
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cancelAllStopOrder</span><span class="hljs-params">(self)</span>:</span>
        self.ctaEngine.cancelAllStopOrder(self.name)

    batchCancelOrder批量撤单，如果单特别多，使用cancelOrder会慢，所以用batchCancelOrder
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">batchCancelOrder</span><span class="hljs-params">(self,vtOrderIDList)</span>:</span>
        <span class="hljs-keyword">if</span> len(vtOrderIDList)&gt;<span class="hljs-number">5</span>:
            self.writeCtaLog(<span class="hljs-string">u'策略发送批量撤单委托失败，单量超过5张'</span>)
            <span class="hljs-keyword">return</span>
        self.ctaEngine.batchCancelOrder(vtOrderIDList)
    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    <span class="hljs-comment"># def insertTick(self, tick):</span>
    <span class="hljs-comment">#     """向数据库中插入tick数据"""</span>
    <span class="hljs-comment">#     self.ctaEngine.insertData(self.tickDbName, self.vtSymbol, tick)</span>

    <span class="hljs-comment">#     # ----------------------------------------------------------------------</span>
    <span class="hljs-comment"># def insertBar(self, bar):</span>
    <span class="hljs-comment">#     """向数据库中插入bar数据"""</span>
    <span class="hljs-comment">#     self.ctaEngine.insertData(self.barDbName, self.vtSymbol, bar)</span>

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    回测中使用，但实盘没有tick可以load所以不loadtick
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">loadTick</span><span class="hljs-params">(self, hours=<span class="hljs-number">1</span>)</span>:</span>
        <span class="hljs-string">"""读取tick数据"""</span>
        <span class="hljs-keyword">return</span> self.ctaEngine.loadTick(self.tickDbName, self.symbolList, hours)

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">loadBar</span><span class="hljs-params">(self, hours=<span class="hljs-number">1</span>)</span>:</span>
        <span class="hljs-string">"""读取bar数据"""</span>
        <span class="hljs-keyword">return</span> self.ctaEngine.loadBar(self.barDbName, self.symbolList, hours)

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    非常重要的功能，会把日志打下来，方便复盘，但记住别放在交易逻辑之前，尽量放在之后
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">writeCtaLog</span><span class="hljs-params">(self, content)</span>:</span>
        <span class="hljs-string">"""记录CTA日志"""</span>
        content = self.name + <span class="hljs-string">':'</span> + content
        self.ctaEngine.writeCtaLog(content)

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">putEvent</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""发出策略状态变化事件"""</span>
        self.ctaEngine.putStrategyEvent(self.name)

    <span class="hljs-comment"># ----------------------------------------------------------------------</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getEngineType</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""查询当前运行的环境"""</span>
        <span class="hljs-keyword">return</span> self.ctaEngine.engineType

    <span class="hljs-comment">#----------------------------------------------------------------------</span>
    <span class="hljs-comment"># def saveSyncData(self):</span>
    <span class="hljs-comment">#     """保存同步数据到数据库"""</span>
    <span class="hljs-comment">#     if self.trading:</span>
    <span class="hljs-comment">#         self.ctaEngine.saveSyncData(self)</span>

    <span class="hljs-comment">#--------------------------------------------------    </span>
    <span class="hljs-comment"># def loadSyncData(self):</span>
    <span class="hljs-comment">#     """从数据库读取同步数据"""</span>
    <span class="hljs-comment">#     self.ctaEngine.loadSyncData(self)</span>

    <span class="hljs-comment">#----------------------------------------------------------------------</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getPriceTick</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""查询最小价格变动"""</span>
        <span class="hljs-keyword">return</span> self.ctaEngine.getPriceTick(self)
    
    loadHistoryBar可以在实盘中通过交易所提供的restful Api获取一定数量的bar，
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">loadHistoryBar</span><span class="hljs-params">(self,vtSymbol,type_,size= None,since = None)</span>:</span>
        <span class="hljs-string">"""策略开始前下载历史数据"""</span>

        <span class="hljs-keyword">if</span> type_ <span class="hljs-keyword">in</span> [<span class="hljs-string">"1min"</span>,<span class="hljs-string">"5min"</span>,<span class="hljs-string">"15min"</span>,<span class="hljs-string">"30min"</span>,<span class="hljs-string">"60min"</span>,<span class="hljs-string">"120min"</span>,<span class="hljs-string">"240min"</span>,<span class="hljs-string">"360min"</span>,<span class="hljs-string">"480min"</span>,<span class="hljs-string">"1day"</span>,<span class="hljs-string">"1week"</span>,<span class="hljs-string">"1month"</span>]:
            data = self.ctaEngine.loadHistoryBar(vtSymbol,type_,size,since)
            lastbar = data[<span class="hljs-number">-1</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-string">'min'</span> <span class="hljs-keyword">in</span> type_:
                minute = int(type_[:<span class="hljs-number">-3</span>])

            <span class="hljs-keyword">if</span> datetime.now() &lt; (lastbar.datetime + timedelta(seconds = <span class="hljs-number">60</span>*minute)):
                self.writeCtaLog(<span class="hljs-string">u'加载历史数据抛弃最后一个非完整K线，频率%s，时间%s'</span>%(type_, lastbar.datetime))
                data = data[:<span class="hljs-number">-1</span>]
                
            <span class="hljs-keyword">return</span> data
            
        <span class="hljs-keyword">else</span>:
            self.writeCtaLog(
                <span class="hljs-string">u'下载历史数据参数错误，请参考以下参数["1min","5min","15min","30min","60min","120min","240min","360min","480min","1day","1week","1month"]，同时size建议不大于2000'</span>)
            <span class="hljs-keyword">return</span>
    策略内不会使用到
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">qryOrder</span><span class="hljs-params">(self, vtSymbol, status= None)</span>:</span>
        <span class="hljs-string">"""查询特定的订单"""</span>
        <span class="hljs-keyword">return</span> self.ctaEngine.qryOrder(vtSymbol,self.name,status)

    
    可以给自己发邮件，在实盘中启用
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mail</span><span class="hljs-params">(self,my_context)</span>:</span>
        <span class="hljs-string">"""邮件发送模块"""</span>
        <span class="hljs-keyword">if</span> self.ctaEngine.engineType == ENGINETYPE_BACKTESTING:
            <span class="hljs-keyword">pass</span>
        <span class="hljs-keyword">else</span>:
            msg = mail(my_context,self)
            self.writeCtaLog(<span class="hljs-string">'%s'</span>%msg)
    不会使用到
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initBacktesingData</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">if</span> self.ctaEngine.engineType == ENGINETYPE_BACKTESTING:
            <span class="hljs-keyword">if</span> self.ctaEngine.mode == <span class="hljs-string">'bar'</span>:
                initdata = self.loadBar()
                <span class="hljs-keyword">for</span> bar <span class="hljs-keyword">in</span> initdata:
                    self.onBar(bar)  <span class="hljs-comment"># 将历史数据直接推送到onBar</span>

            <span class="hljs-keyword">elif</span> self.ctaEngine.mode ==<span class="hljs-string">'tick'</span>:
                initdata = self.loadTick()
                <span class="hljs-keyword">for</span> tick <span class="hljs-keyword">in</span> initdata:
                    self.onTick(tick)  <span class="hljs-comment"># 将历史数据直接推送到onTick  </span>
    
    注册一个函数onXmimBar写函数名字
    xmin写分钟数，必须是整分钟，比如<span class="hljs-number">5</span>，<span class="hljs-number">15</span> 这种，可以参考行情软件上的k线时间
    然后会自动生成两个变量通过setattr(key,value)
    一个是BarGenerator对象的
    一个是ArrayManager对象的
    名字是
    <span class="hljs-comment"># if xmin: </span>
    <span class="hljs-comment">#         variable = "bg%sDict"%xmin</span>
    <span class="hljs-comment">#         variable2 = "am%sDict"%xmin</span>
    <span class="hljs-comment">#     else:</span>
    <span class="hljs-comment">#         variable = "bgDict"</span>
    <span class="hljs-comment">#         variable2 = "amDict"</span>
    随后再介绍这两个类
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generateBarDict</span><span class="hljs-params">(self, onBar, xmin=<span class="hljs-number">0</span>, onXminBar=None, size = <span class="hljs-number">100</span>, alignment=<span class="hljs-string">'sharp'</span>, marketClose = <span class="hljs-params">(<span class="hljs-number">23</span>,<span class="hljs-number">59</span>)</span>)</span>:</span>
        <span class="hljs-keyword">if</span> xmin: 
            variable = <span class="hljs-string">"bg%sDict"</span>%xmin
            variable2 = <span class="hljs-string">"am%sDict"</span>%xmin
        <span class="hljs-keyword">else</span>:
            variable = <span class="hljs-string">"bgDict"</span>
            variable2 = <span class="hljs-string">"amDict"</span>
        bgDict= {
            sym: BarGenerator(onBar,xmin,onXminBar, alignment=alignment, marketClose=marketClose)
            <span class="hljs-keyword">for</span> sym <span class="hljs-keyword">in</span> self.symbolList }
        
        amDict = {
            sym: ArrayManager(size)
            <span class="hljs-keyword">for</span> sym <span class="hljs-keyword">in</span> self.symbolList }

        setattr(self, variable, bgDict)
        setattr(self, variable2, amDict)

    秒级别的bar，类似分钟级别的参数，一般是给高频，而且秒级别的噪声很大，一般需要很长的研究过程
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generateHFBar</span><span class="hljs-params">(self,xSecond,size = <span class="hljs-number">60</span>)</span>:</span>
        self.hfDict = {sym: BarGenerator(self.onHFBar,xSecond = xSecond)
                        <span class="hljs-keyword">for</span> sym <span class="hljs-keyword">in</span> self.symbolList}
        self.amhfDict = {sym: ArrayManager(size) <span class="hljs-keyword">for</span> sym <span class="hljs-keyword">in</span> self.symbolList}

</div></code></pre>

    </body>
    </html>